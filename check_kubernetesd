#!/usr/bin/env python3
""" kubernetes zabbix monitoring daemon
    - tries to read config from file (host, port, token)
    - sends data to zabbix
    - sends data to inventory REST-API
"""
import os

import sys
import importlib.util

import logging
import signal
import time
import argparse

from modules.daemon_thread import CheckKubernetesDaemon

KNOWN_ACTIONS = ['discover', 'get']

formatter = logging.Formatter('%(asctime)s - %(threadName)s : %(levelname)s : %(name)s - %(message)s')
stream = logging.StreamHandler(sys.stdout)
stream.setFormatter(formatter)

logger = logging.getLogger()

if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        description='Monitoring daemon for kubernetes'
    )

    parser.add_argument(
        '--zabbix_debug',
        help='show zabbix debug info',
        action='store_true', )

    args, remaining_args = parser.parse_known_args()

    if len(remaining_args) < 1:
        parser.error('add <CONFIG_NAME> or <executable>')
        sys.exit(1)

    if remaining_args[0].startswith("/bin/"):
        os.system(remaining_args[0])
        sys.exit(1)

    config_name = remaining_args[0]

    try:
        config = importlib.import_module(config_name)
    except ImportError:
        print("config file %s.py not found. ABORTING!" % config_name)
        sys.exit(1)

    for key in ["k8s_api_host", "k8s_api_token", "verify_ssl", "debug", "zabbix_server", "zabbix_host",
                "zabbix_debug", "discovery_interval_slow", "data_interval_slow",
                "discovery_interval_fast", "data_interval_fast"]:
        if key.upper() in os.environ and os.environ[key.upper()] != "":
            print("setting %s by environment variable %s" % (key, key.upper()))
            setattr(config, key, os.environ[key.upper()])

    if args.zabbix_debug:
        logger.info("starting with zabbix debug")
        config.zabbix_debug = True

    if config.debug:
        stream.setLevel(logging.DEBUG)
        logger.setLevel(logging.DEBUG)
    else:
        logger.setLevel(logging.INFO)
    logger.addHandler(stream)

    daemons = list()

    daemons.append(CheckKubernetesDaemon(config, config_name, ['nodes', 'components', 'tls', 'services'],
                                         config.discovery_interval_slow, config.data_interval_slow))

    daemons.append(CheckKubernetesDaemon(config, config_name, ['deployments', 'pods'],
                                         config.discovery_interval_slow, config.data_interval_fast))

    try:
        logger.info("Starting daemon threads now")
        for daemon in daemons:
            daemon.run()
        while True:
            for daemon in daemons:
                if daemon.dirty_threads:
                    daemon.restart_dirty_threads()
            time.sleep(3)
    except KeyboardInterrupt:
        daemon.handler(signal.SIGTERM)
        time.sleep(3)
        daemon.handler(signal.SIGKILL)
